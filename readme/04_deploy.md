# Деплой приложения
1. В созданной ранее группе проектов Gitlab создать два новых проекта: один для приложения, другой для интерфейса.
2. В настройках группы в разделе **CI/CD** раскрыть блок **Variables** и создать переменные окружения:
    - `DOCKER_REGISTRY_USER` — логин пользователя Docker Hub, в чей репозиторий будут загружаться создаваемые образы приложения;
    - `DOCKER_REGISTRY_PASSWORD` — пароль пользователя Docker Hub;
    - `RMQ_USERNAME` — логин пользователя RabbitMQ, который задаётся в файле **ansible\roles\rabbitmq\tasks\main.yml**. В нашем случае — `admin`;
    - `RMQ_PASSWORD` — пароль пользователя RabbitMQ, который задаётся в файле **ansible\roles\rabbitmq\tasks\main.yml**. В нашем случае — `admin`;
    - `DEPLOY_USER` — имя пользователя для деплоя, создаваемого при выполнении плейбука **ansible\playbooks\create_user.yml**. Само имя задаётся в файле **ansible\group_vars\all**. В нашем случае — `ops`;
    - `STAGE_VM` — IP-адрес машины **stage**;
    - `PROD_VM` — IP-адрес машины **prod**.
3. Склонировать на локальную машину репозитории приложения и его графического интерфейса с содержащимися там файлами **Dockerfile** и **.gitlab-ci.yml**:
    ```bash
    $ git clone https://github.com/rustsh/search_engine_crawler.git
    $ git clone https://github.com/rustsh/search_engine_ui.git
    ```
    *Альтернативный вариант:*  
Добавить в свои репозитории с приложением и интерфейсом соответствующие файлы из папки **app-files/** инфраструктурного репозитория, переименовав их в **Dockerfile** и **.gitlab-ci.yml**.
4. Добавить в каждый из локальных репозиториев приложения ссылку на удалённый репозиторий в Gitlab (в соответствующий проект):
    ```bash
    $ git remote add gitlab http://<ci-IP>/<group-name>/<project-name>.git
    ```
5. В каждом репозитории приложения выполнить команду:
    ```bash
    $ git push gitlab <branch-name>
    ```
    В каждом проекте будет запущен конвейер по сборке, тестированию и публикации приложения. Если сборка запущена из ветки **master**, то появится дополнительный шаг публикации на сервер **prod**, который необходимо запустить вручную из графического интерфейса Gitlab. Этот конвейер будет запускаться при каждом выполнении `push` в удалённый репозиторий **gitlab**.

## Результат
В каждом проекте Gitlab'а созданы тестовое (**stage**) и рабочее (**production**) окружения (вкладка **Environments** раздела **Operations**).

Приложение опубликовано на машинах **stage** и **prod**, а собранные в результате работы конвейера docker-образы загружены в Docker Hub.

## Как проверить
Открыть страницы и убедиться в работоспособности приложения:
- http://\<stage-IP\>:8000 — тестовое окружение;
- http://\<prod-IP\>:8000 — рабочее окружение.

## Замечание
Если сделать *форк* репозиториев с приложением и интерфейсом, после чего добавить их в Gitlab, то возможны проблемы с публикацией приложения из ветки **master**: сборка может падать при попытке залогиниться на Docker Hub, так как переменная окружения с паролем от учётной записи Docker Hub в этом случае передаёт пустое значение. Это связано с настройками безопасности и особенностями Gitlab.

<br/>

Предыдущий шаг: [Подготовка инфраструктуры](03_prepare.md)

<br/>

[Вернуться на главную страницу](../README.md)
