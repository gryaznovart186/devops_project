# Подготовка инфраструктуры
1. Перейти в папку **ansible/**.
2. Переименовать файл **ansible.cfg.example** в **ansible.cfg**, а **inventory.example** в **inventory**. В файле **ansible.cfg** указать логин пользователя, от имени которого будут выполняться плейбуки, и расположение закрытого SSH-ключа. В файле **inventory** в соответствующих группах нужно перечислить актуальные IP-адреса созданных виртуальных машин (взяв их из выходных переменных Terraform или из консоли управления GCP).
3. Задать настройки для интеграции Alertmanager и Slack:
    - создать Incoming WebHook в пространстве Slack;
    - указать Webhook URL и название канала для оповещений в файле **roles\alertmanager\files\alertmanager.yml**.
4. Выполнить плейбук **playbooks/start.yml** (выполнение — около 10,5 минут):
    ```bash
    $ ansible-playbook playbooks/start.yml
    ```
5. Сделать предварительные настройки Gitlab'а в графическом интерфейсе:
    - открыть страницу **http://\<ci-IP\>**;
    - задать пароль для пользователя Administrator, после чего зайти с логином `root` и этим паролем;
    - создать группу для проектов. Сразу же можно создать проекты и переменные окружения — более подробно они будут описаны далее;
    - в настройках группы в разделе **CI/CD** раскрыть блок **Runners** и скопировать регистрационный токен.
6. Установить и зарегистрировать раннер Gitlab'а. Для этого необходимо указать сохранённый на предыдущем шаге токен как значение переменной `registration_token` в файле **playbooks/gitlab-runner.yml** и выполнить сам плейбук:
    ```bash
    $ ansible-playbook playbooks/gitlab-runner.yml
    ```
7. Настроить Grafana в графическом интерфейсе:
    - открыть страницу **http://\<monitor-IP\>:3000**;
    - авторизоваться в системе со стандартными логином и паролем (`admin` для обоих значений), изменить пароль;
    - указать Prometheus в качестве источника данных;
    - загрузить дашборды из папки **grafana-dashboards/**.

## Результат
1. На всех виртуальных машинах обновлена операционная система и все предустановленные пакеты, отключены firewalld и SELinux, установлен и запущен Docker.
2. На машине **ci** установлены и запущены в контейнерах Gitlab и раннер, создана группа для проектов, раннер зарегистрирован и доступен для этой группы.
3. На машине **monitor** установлены и настроены Prometheus, Grafana и Alertmanager. Для них поднята единая сеть (docker network). Настроена интеграция Alertmanager и Slack.
4. На машине **prod** установлены экспортеры для системы мониторинга: cAdvisor, Node Exporter и RabbitMQ Exporter.
5. На машинах **ci**, **stage** и **prod** создан пользователь для деплоя приложения. На машине **ci** создана пара SSH-ключей для этого пользователя, открытый ключ скопирован в файл **authorized_keys** на машинах **stage** и **prod**.
6. На машинах **stage** и **prod** запущены MongoDB и RabbitMQ в контейнерах, в RabbitMQ создана очередь **urls**. Для них, а также для компонентов приложения и экспортеров поднята единая сеть (docker network).

## Как проверить
1. Открыть перечисленные ниже страницы и убедиться, что указанные сервисы запущены:
    - http://\<ci-IP\> — Gitlab;
    - http://\<monitor-IP\>:9090 — Prometheus;
    - http://\<monitor-IP\>:3000 — Grafana;
    - http://\<monitor-IP\>:9093 — Alertmanager;
    - http://\<prod-IP\>:8080 — cAdvisor;
    - http://\<prod-IP\>:9100 — Node Exporter;
    - http://\<prod-IP\>:9419 — RabbitMQ Exporter;
2. На странице Gitlab открыть настройки группы, в разделе **CI/CD** раскрыть блок **Runners** и убедиться, что зарегистированный раннер доступен.
3. Подключиться к виртуальным машинам **stage** и **prod** по SSH и убедиться, что docker-контейнеры с MongoDB и RabbitMQ запущены.

<br/>

Следующий шаг: [Деплой приложения](04_deploy.md)

Предыдущий шаг: [Создание инфраструктуры](02_infrastructure.md)

<br/>

[Вернуться на главную страницу](../README.md)
