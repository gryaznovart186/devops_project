# Описание плейбуков и ролей Ansible
## Оглавление
- [Плейбуки](#playbooks)
- [Роли](#roles)

## Плейбуки <a name="playbooks"></a>
Плейбуки перечислены в порядке выполнения в проекте.

### start.yml
Последовательно запускает плейбуки:
- initial.yml;
- gitlab.yml;
- monitoring.yml;
- create_user.yml;
- rmq_mongo.yml.

### initial.yml
На всех машинах выполняется:
- обновление системы и установленных пакетов;
- отключение firewalld и SELinux;
- установка и запуск Docker;
- перезагрузка сервера.

### gitlab.yml
Выполняет роль gitlab на сервере **ci**.

### monitoring.yml
Выполняет роли на сервере **monitor**:
- network
- prometheus
- alertmanager
- grafana

Выполняет роли на сервере **prod**:
- network
- node-exporter
- rmq-exporter
- cadvisor

### create_user.yml
Состоит из трёх плеев:
- на серверах **ci**, **stage** и **prod** создаёт пользователя для деплоя приложения. Имя пользователя задаётся в переменной `runner_user` в файле **group_vars/all**;
- создаёт пару SSH-ключей для созданного пользователя на сервере **ci**;
- записывает открытый ключ этого пользователя в файл **authorized_keys** на серверах **stage** и **prod**.

### rmq_mongo.yml
Выполняет роли на серверах **stage** и **prod**:
- network
- rabbitmq
- mongodb

### gitlab-runner.yml
Выполняет роль gitlab-runner на сервере **ci**.

### run-crawler.yml
Выполняет роль crawler-app. В проекте не используется.

### run-ui.yml
Выполняет роль crawler-ui. В проекте не используется.

## Роли <a name="roles"></a>
Роли перечислены в алфавитном порядке.

Переменные, используемые внутри ролей:
- `network` — docker-сеть, в которой будет запущен docker-контейнер;
- `version` — тег запускаемого docker-контейнера.

Значения переменных `network` и `version` задаются в плейбуке, вызывающем роль.

Если в роли дополнительно используются другие переменные, они перечислены в описании конкретной роли.

### alertmanager
- Запускает контейнер с Alertmanager;
- копирует на сервер файл **alertmanager.yml** с конфигурацией Alertmanager. Перед выполнением роли в этот файл необходимо подставить webhook URL и название канала в Slack, в который будут приходить оповещения.

### cadvisor
Запускает контейнер с cAdvisor.

### crawler-app
Запускает контейнер с приложением crawler.

В данном проекте не используется. Сохранён на случай, если получится подружить раннер Gitlab'а и Ansible.

### crawler-ui
Запускает контейнер с приложением ui.

В данном проекте не используется. Сохранён на случай, если получится подружить раннер Gitlab'а и Ansible.

### gitlab
- Создаёт папки для монтирования к docker-контейнеру с Gitlab;
- запускает контейнер с Gitlab.

Переменные, задаваемые в файле **defaults/main.yml**:
- `gitlab_config_dir` — каталог сервера для монтирования к каталогу **/etc/gitlab** внутри docker-контейнера с Gitlab;
- `gitlab_logs_dir` — каталог сервера для монтирования к каталогу **/var/log/gitlab** внутри docker-контейнера с Gitlab;
- `gitlab_data_dir` — каталог сервера для монтирования к каталогу **/var/opt/gitlab** внутри docker-контейнера с Gitlab;
- `gitlab_image` — название docker-образа Gitlab.

Если монтировать порт 22 контейнера к порту 22 сервера, то запуск контейнера падает с ошибкой, так как этот порт уже занимает Ansible. Поэтому на стороне сервера нужно выбрать другой порт, например, 2222. Этот порт указан в переменной окружения `GITLAB_OMNIBUS_CONFIG` путём добавления в неё строки `gitlab_rails['gitlab_shell_ssh_port'] = 2222`.

### gitlab-runner
- Создаёт папку для монтирования к docker-контейнеру с раннером Gitlab'а;
- запускает контейнер c раннером Gitlab'а;
- регистрирует раннер.

Переменные, задаваемые в файле **defaults/main.yml**:
- `gitlab_runner_config_dir` — каталог сервера для монтирования к каталогу **/etc/gitlab-runner** внутри docker-контейнера с раннером;
- `gitlab_runner_image` — название docker-образа раннера.

Переменная `runner_user` содержит имя пользователя, созданного в плейбуке create_user.yml, и задаётся в файле **group_vars/all**.

Перед выполнением роли необходимо подставить регистрационный токен в переменную `registration_token` в плейбуке gitlab-runner.yml.

### grafana
- Создаёт папку для монтирования к docker-контейнеру с Grafana;
- запускает контейнер с Grafana.

### mongodb
- Создаёт папку для монтирования к docker-контейнеру с MongoDB;
- запускает контейнер с MongoDB.

### network
Создаёт docker-сеть.

### node-exporter
Запускает контейнер с Node Exporter.

### prometheus
- Создаёт папку для монтирования к docker-контейнеру с Prometheus;
- создаёт на сервере файл **prometheus.yml** из шаблона **prometheus.yml.j2**;
- копирует на сервер файл **alerts.yml**
- запускает контейнер с Prometheus.

В файле **prometheus.yml.j2** шаблонизирован IP-адрес сервера рабочего окружения.

### rabbitmq
- Создаёт папку для монтирования к docker-контейнеру с RabbitMQ;
- запускает контейнер с RabbitMQ;
- ждёт одну минуту, чтобы убедиться, что RabbitMQ запущен;
- добавляет очередь urls.

Здесь задаются логин и пароль для доступа к RabbitMQ: **admin** для обоих значений.

### rmq-exporter
Запускает контейнер с RabbitMQ Exporter.

<br/>

[Вернуться на главную страницу](../README.md)
